
{% extends "ui/base.html" %}

{% block content %}
<div class="container" style="max-width: 1100px; margin-top: 25px;">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Détails du Conteneur : {{ shipment.container_no }}</h2>
    <span class="badge bg-primary fs-6">Statut: {{ shipment.status }}</span>
  </div>

  <div class="row">
    <div class="col-lg-8">
      
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-body bg-light" style="border-radius: 10px;">
          <div class="row">
            <div class="col-md-6 border-end">
              <h6 class="text-muted small fw-bold text-uppercase">Expéditeur</h6>
              <p class="mb-1"><b>Client :</b> {{ shipment.client_name }}</p>
              <p class="mb-0"><b>Pays :</b> {{ shipment.origin_country }}</p>
            </div>
            <div class="col-md-6 ps-4">
              <h6 class="text-muted small fw-bold text-uppercase">Destinataire</h6>
              <p class="mb-1"><b>Site :</b> {{ shipment.destination_site }}</p>
              <p class="mb-0"><b>N° BL :</b> {{ shipment.bl_no }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">Documents de transport</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Document</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for d in documents %}
                <tr>
                  <td>
                    <b>{{ d.doc_type }}</b><br>
                    <small class="text-muted">v{{ d.version }} - {{ d.uploaded_at|date:"d/m/Y" }}</small>
                  </td>
                  <td class="text-end">
                    <a href="{{ d.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">Voir</a>
                    <form method="post" action="{% url 'shipment_documents' shipment.id %}" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="share">
                      <input type="hidden" name="document_id" value="{{ d.id }}">
                      <button type="submit" class="btn btn-sm btn-primary">Partager</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if share_url %}
          <div class="alert alert-info mt-2 mb-0 py-2">
            <small>Lien : <code>{{ share_url }}</code></small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">Historique</h5>
        </div>
        <div class="card-body">
          <div class="timeline-small">
            {% for update in shipment.updates.all|dictsortreversed:"created_at" %}
            <div class="mb-3 ps-3 border-start border-primary border-3 position-relative">
              <div class="position-absolute bg-primary rounded-circle" style="width:12px; height:12px; left:-8px; top:0;"></div>
              <div class="small fw-bold">{{ update.status }}</div>
              <div class="text-muted" style="font-size: 0.8rem;">{{ update.created_at|date:"d M Y, H:i" }}</div>
              <div class="small mt-1">{{ update.notes|default:"" }}</div>
            </div>
            {% empty %}
            <p class="text-muted small">Aucun historique disponible.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mt-4" style="border-radius: 12px;">
    <div class="card-header bg-dark text-white">Discussion</div>
    <div id="chat-box" style="height: 300px; overflow-y: auto; padding: 15px; background-color: #f8f9fa;">
      {% for msg in chat_messages %}
      <div class="mb-3 {% if msg.author == request.user %}text-end{% endif %}">
        <div class="d-inline-block p-2 rounded shadow-sm" style="max-width: 80%; {% if msg.author == request.user %}background-color: #007bff; color: white;{% else %}background-color: white;{% endif %}">
          <small class="d-block fw-bold" style="font-size: 0.7rem;">{{ msg.author.username }}</small>
          {{ msg.body }}
          <small class="d-block mt-1 text-end" style="font-size: 0.6rem; opacity: 0.8;">{{ msg.created_at|date:"H:i" }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="card-footer bg-white">
      <form method="post" action="{% url 'shipment_detail' shipment.id %}#chat" class="d-flex gap-2">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="chat">
        <input type="text" name="body" class="form-control rounded-pill" placeholder="Message..." required>
        <button type="submit" class="btn btn-primary rounded-pill">Envoyer</button>
      </form>
    </div>
  </div>
</div>

<script>
  window.onload = function() {
    var cb = document.getElementById("chat-box");
    if(cb) cb.scrollTop = cb.scrollHeight;
  };
</script>
{% endblock %}