{% extends "ui/base.html" %}
{% block content %}

<div class="container" style="max-width: 1100px; margin-top: 25px;">

  <h2>Conteneur</h2>
  <div class="card" style="padding: 16px; margin-bottom: 18px;">
    <div><b>No conteneur :</b> {{ shipment.container_no }}</div>
    <div><b>No BL :</b> {{ shipment.bl_no }}</div>
    <div><b>Pays origine :</b> {{ shipment.origin_country }}</div>
    <div style="margin-top:10px;"><b>Site destination :</b> {{ shipment.destination_site }}</div>
    <div><b>Client :</b> {{ shipment.client_name }}</div>
  </div>

  <h3>Marchandises</h3>
  <div class="card" style="padding: 16px; margin-bottom: 18px;">
    <table class="table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Qte</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
          <tr>
            <td>{{ it.product.name }}</td>
            <td>{{ it.qty }}</td>
            <td>{{ it.line_total }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3">Aucun item</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h3>Documents</h3>

  {% if share_url %}
    <div class="alert alert-success">
      <b>Lien de partage :</b>
      <input type="text" value="{{ share_url }}" readonly style="width:100%; padding:8px; margin-top:8px;">
    </div>
  {% endif %}

  <div class="card" style="padding: 16px; margin-bottom: 18px;">

    <!-- Form upload (si tu l’utilises déjà, tu peux le garder et supprimer ce bloc) -->
    <form method="post" action="/shipments/{{ shipment.id }}/documents/" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center; margin-bottom:14px;">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload">
      <input type="text" name="doc_type" placeholder="Titre" class="form-control" style="max-width: 260px;">
      <input type="file" name="file" class="form-control">
      <button class="btn btn-primary" type="submit">Ajouter</button>
    </form>

    <table class="table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Version</th>
          <th>Ajouté</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in documents %}
          <tr>
            <td>{{ d.doc_type }}</td>
            <td>{{ d.version }}</td>
            <td>{{ d.uploaded_at }}</td>
            <td style="display:flex; gap:8px; align-items:center;">
              <a class="btn btn-sm btn-outline-primary" href="{{ d.file.url }}" target="_blank">Ouvrir</a>

              {% if d.can_share %}
              <form method="post" action="/shipments/{{ shipment.id }}/documents/" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="share">
                <input type="hidden" name="document_id" value="{{ d.id }}">
                <button class="btn btn-sm btn-outline-secondary" type="submit">Partager</button>
              </form>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4">Aucun document</td></tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <h3 id="chat">Discussion</h3>
  <div class="card" style="padding: 16px; margin-bottom: 18px;">
    <div style="margin-bottom:12px;">
      {% for msg in chat_messages %}
        <div style="margin-bottom:8px;">
          <b>{{ msg.author.email }}</b> : {{ msg.body }}
        </div>
      {% empty %}
        <div>Aucun message</div>
      {% endfor %}
    </div>

    <form method="post" action="/shipments/{{ shipment.id }}/#chat" style="display:flex; gap:10px;">
      {% csrf_token %}
      <input type="hidden" name="form_name" value="chat">
      <input class="form-control" type="text" name="body" placeholder="Message...">
      <button class="btn btn-primary" type="submit">Envoyer</button>
    </form>
  </div>

</div>

{% endblock %}
