{% extends "ui/base.html" %}
{% load avatar %}
{% load user_display %}

{% block content %}
<div class="container py-4 shipment-page" style="max-width: 1200px;">

  <!-- Header / User -->
  <div class="card ff-card mb-4 top-card">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div class="d-flex align-items-center">
        <img
          src="{{ request.user|avatar_url }}"
          alt="Avatar"
          width="48"
          height="48"
          class="rounded-circle border"
          style="object-fit: cover;"
        />
        <div class="ms-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <h5 class="mb-0 fw-bold">{{ request.user|display_name }}</h5>
            <span class="badge badge-agent-online">Agent connecté</span>
          </div>
          <p class="mb-0 small ff-muted">{{ request.user.email }}</p>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="d-flex align-items-center gap-2 ms-auto">
        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary rounded-pill px-3 ff-btn ff-btn--sm">
          <i class="bi bi-arrow-left me-1"></i>Retour
        </a>
        <a href="#chat" class="btn btn-sm btn-primary rounded-pill px-3 ff-btn ff-btn--sm">
          <i class="bi bi-chat-dots me-1"></i>Discussion
        </a>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Main -->
    <div class="col-lg-8">

      <!-- Shipment summary -->
      <div class="card ff-card mb-4 section-card">
        <div class="card-header border-0 py-3 d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-box-seam me-2 text-primary"></i>
              Conteneur <span class="text-muted">#</span>{{ shipment.container_no }}
            </h5>
            <div class="small mt-1 ff-muted">
              <i class="bi bi-geo-alt me-1"></i>{{ shipment.origin_country }}
              <span class="mx-2">•</span>
              <i class="bi bi-truck me-1"></i>{{ shipment.destination_site }}
            </div>
          </div>
          <span class="badge rounded-pill px-3 py-2 {% if shipment.status == 'IN_TRANSIT' %}badge-in-transit{% else %}bg-primary{% endif %}">{{ shipment.status }}</span>
        </div>

        <div class="card-body border-top">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="info-card">
                <div class="info-label">Expéditeur</div>
                <div class="info-value">{{ shipment.client_name }}</div>
                <div class="info-sub">{{ shipment.origin_country }}</div>
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="info-card">
                <div class="info-label">Destination</div>
                <div class="info-value">{{ shipment.destination_site }}</div>
                <div class="info-sub">BL : <span class="fw-semibold">{{ shipment.bl_no }}</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Documents -->
      <div class="card ff-card section-card">
        <div class="card-header border-0 py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-file-earmark-text me-2 text-primary"></i>Documents officiels
          </h5>
          <span class="small ff-muted">Total : {{ documents|length }}</span>
        </div>

        
       <div class="px-3 mb-4">
    <form method="post" action="{% url 'shipment_documents' shipment.id %}" enctype="multipart/form-data" class="row g-2 p-3 ff-card--soft" style="border-radius: 12px; border: 1px dashed var(--stroke);">
        {% csrf_token %}
        <input type="hidden" name="action" value="upload">
        
        <div class="col-md-4">
            <input type="text" name="doc_type" placeholder="Nom du document (ex: Facture)" class="form-control form-control-sm ff-input" required>
        </div>
        
        <div class="col-md-5">
            <input type="file" name="file" class="form-control form-control-sm ff-input" required>
        </div>
        
        <div class="col-md-3">
            <button type="submit" class="btn btn-sm btn-primary btn-primary-unified w-100">
                <i class="bi bi-plus-circle me-1"></i>Charger
            </button>
        </div>
    </form>
</div>

        <div class="table-responsive px-3 pb-3">
          <table class="table table-hover align-middle doc-table mb-0 ff-table">
            <thead>
              <tr>
                <th>Type</th>
                <th class="text-center" style="width: 120px;">Version</th>
                <th class="text-end" style="width: 220px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for d in documents %}
              <tr>
                <td>
                  <div class="fw-bold">{{ d.doc_type }}</div>
                  <div class="small ff-muted">
                    <i class="bi bi-calendar3 me-1"></i>Ajouté le {{ d.uploaded_at|date:"d/m/Y" }}
                  </div>
                </td>

                <td class="text-center">
                  <span class="badge rounded-pill badge-soft-dark">v{{ d.version }}</span>
                </td>

                <td class="text-end">
                  <div class="btn-group">
                    <a href="{{ d.file.url }}" class="btn btn-sm btn-primary btn-primary-unified" target="_blank">
                      <i class="bi bi-eye me-1"></i>Voir
                    </a>

                    <form method="post" action="{% url 'shipment_documents' shipment.id %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="share">
                      <input type="hidden" name="document_id" value="{{ d.id }}">
                      <button type="submit" class="btn btn-sm btn-primary btn-primary-unified">
                        <i class="bi bi-share me-1"></i>Partager
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3">
                  <div class="text-center py-4">
                    <i class="bi bi-folder2-open text-muted fs-2"></i>
                    <p class="text-muted small mt-2 mb-0">Aucun document disponible.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card ff-card section-card">
        <div class="card-header border-0 py-3">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-clock-history me-2 text-primary"></i>Historique du trajet
          </h5>
        </div>

        <div class="card-body">
          <div class="timeline">
            {% for update in shipment.updates.all|dictsortreversed:"created_at" %}
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <div class="fw-bold small">{{ update.status }}</div>
                  <div class="ff-muted" style="font-size: 0.75rem;">
                    {{ update.created_at|date:"d M Y • H:i" }}
                  </div>
                  {% if update.notes %}
                    <div class="timeline-note">{{ update.notes }}</div>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="text-center py-4">
                <i class="bi bi-clock-history text-muted fs-2"></i>
                <p class="text-muted small mt-2 mb-0">Aucun événement enregistré.</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="mt-5" id="chat">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h5 class="fw-bold mb-0"><i class="bi bi-chat-dots me-2 text-primary"></i>Discussion d'équipe</h5>
      <span class="ff-muted small">{{ chat_messages|length }} message(s)</span>
    </div>

    <div class="card ff-card chat-card">
      <div id="chat-section">
        <div id="chat-box" class="chat-box">
          {% for msg in chat_messages %}
          {% if msg.show_date_separator %}
            <div class="chat-date-separator">{{ msg.date_label }}</div>
          {% endif %}
          <div class="chat-message {% if msg.is_me %}chat-message-me{% endif %}">
            {% if msg.show_avatar %}
              <div class="chat-avatar">
                {% if msg.avatar_url %}
                  <img src="{{ msg.avatar_url }}" alt="Avatar">
                {% else %}
                  <div class="chat-initials">{{ msg.initials }}</div>
                {% endif %}
              </div>
            {% else %}
              <div class="chat-avatar-spacer"></div>
            {% endif %}
            <div class="chat-content">
              {% if msg.show_avatar %}
                <div class="chat-author">{{ msg.author_name }}</div>
              {% endif %}
              <div class="chat-bubble {% if msg.is_me %}chat-bubble-me{% else %}chat-bubble-other{% endif %}">
                <div class="chat-text">{{ msg.body }}</div>
                <div class="chat-time">{{ msg.created_at|date:"H:i" }}</div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-center py-5">
            <i class="bi bi-chat-left-text ff-muted fs-2"></i>
            <p class="ff-muted small mt-2 mb-0">Aucun message pour l’instant.</p>
          </div>
        {% endfor %}
        </div>
      </div>

      <div class="p-3 border-top" style="border-color: var(--stroke);">
        <form id="chat-form" method="post" action="{% url 'shipment_detail' shipment.id %}#chat" class="d-flex gap-2 align-items-center">
          {% csrf_token %}
          <input type="hidden" name="form_name" value="chat">
          <textarea
            id="chat-input"
            name="body"
            class="form-control chat-input ff-input"
            rows="2"
            placeholder="Tapez votre message ici… (Entrée pour envoyer, Maj+Entrée pour nouvelle ligne)"
            required
          ></textarea>
          <button type="submit" class="btn btn-primary chat-send" id="chat-send" disabled>
            <i class="bi bi-send-fill"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

</div>

<script>
  window.addEventListener("load", function () {
    var chat = document.getElementById("chat-box");
    if (chat) chat.scrollTop = chat.scrollHeight;

    var input = document.querySelector(".chat-input");
    var form = document.getElementById("chat-form");
    var sendBtn = document.getElementById("chat-send");

    function updateSendState() {
      if (!input || !sendBtn) return;
      sendBtn.disabled = !(input.value || "").trim();
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function highlightMentions() {
      var nodes = document.querySelectorAll(".chat-text");
      nodes.forEach(function (node) {
        var raw = node.textContent || "";
        var escaped = escapeHtml(raw);
        var html = escaped.replace(/(@[a-zA-Z0-9._-]+)/g, '<span class="chat-mention">$1</span>');
        node.innerHTML = html;
      });
    }

    if (input && form) {
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if ((input.value || "").trim()) {
            form.requestSubmit();
          }
        }
      });
      input.addEventListener("input", updateSendState);
      updateSendState();
    }

    highlightMentions();
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var focusChat = {{ focus_chat|yesno:"true,false" }};
    if (focusChat) {
      var chat = document.getElementById("chat-section");
      var input = document.getElementById("chat-input");
      if (chat) chat.scrollIntoView({ behavior: "smooth" });
      if (input) input.focus();
    }
  });
</script>
{% endblock %}
