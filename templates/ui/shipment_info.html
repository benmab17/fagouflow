
{% extends "ui/base.html" %}
{% block content %}

<div class="app-shell">

  <!-- FIXED HEADER -->
  <header class="app-header">
    <div class="app-header__left">
      <div class="brand">
        <div class="brand__logo">
          <i class="bi bi-grid-1x2-fill"></i>
        </div>
        <div class="brand__text">
          <div class="brand__name">Operations Suite</div>
          <div class="brand__sub">Suivi conteneurs • Documents • Collaboration</div>
        </div>
      </div>

      <div class="header-divider"></div>

      <div class="header-meta">
        <div class="meta-pill">
          <i class="bi bi-person-circle"></i>
          <span class="fw-semibold">{{ request.user.username }}</span>
          <span class="text-muted">•</span>
          <span class="small text-muted">{{ request.user.email }}</span>
        </div>
        <span class="status-pill">
          <span class="dot"></span> Connecté
        </span>
      </div>
    </div>

    <div class="app-header__right">
      <a href="javascript:history.back()" class="btn btn-sm btn-ghost">
        <i class="bi bi-arrow-left"></i><span>Retour</span>
      </a>
      <a href="#chat" class="btn btn-sm btn-primary btn-pill">
        <i class="bi bi-chat-dots"></i><span>Chat</span>
      </a>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="app-main">
    <div class="container-fluid app-container" style="max-width: 1280px;">
      <div class="row g-4">

        <!-- LEFT (MAIN) -->
        <div class="col-lg-8">

          <!-- Shipment Overview -->
          <section class="card app-card">
            <div class="card-body app-card__header">
              <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
                <div class="d-flex align-items-start gap-3">
                  <div class="icon-tile">
                    <i class="bi bi-box-seam"></i>
                  </div>
                  <div>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <h5 class="mb-0 fw-bold">Conteneur {{ shipment.container_no }}</h5>
                      <span class="badge rounded-pill badge-soft-primary">
                        <i class="bi bi-activity me-1"></i>{{ shipment.status }}
                      </span>
                    </div>
                    <div class="text-muted small mt-1">
                      <i class="bi bi-geo-alt me-1"></i>{{ shipment.origin_country }}
                      <span class="mx-2">•</span>
                      <i class="bi bi-truck me-1"></i>{{ shipment.destination_site }}
                      <span class="mx-2">•</span>
                      <i class="bi bi-receipt me-1"></i>BL : <span class="fw-semibold">{{ shipment.bl_no }}</span>
                    </div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill badge-soft-dark">
                    <i class="bi bi-shield-check me-1"></i>Dossier suivi
                  </span>
                </div>
              </div>
            </div>

            <div class="card-body pt-0">
              <div class="grid-2">
                <div class="info-box">
                  <div class="info-box__label">
                    <i class="bi bi-building me-1"></i>Expéditeur
                  </div>
                  <div class="info-box__value">{{ shipment.client_name }}</div>
                  <div class="info-box__sub">{{ shipment.origin_country }}</div>
                </div>
                <div class="info-box">
                  <div class="info-box__label">
                    <i class="bi bi-flag me-1"></i>Destination
                  </div>
                  <div class="info-box__value">{{ shipment.destination_site }}</div>
                  <div class="info-box__sub">BL : <span class="fw-semibold">{{ shipment.bl_no }}</span></div>
                </div>
              </div>
            </div>
          </section>

          <!-- Documents -->
          <section class="card app-card mt-4">
            <div class="card-body app-card__header">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                  <div class="icon-tile icon-tile--soft">
                    <i class="bi bi-file-earmark-text"></i>
                  </div>
                  <h5 class="mb-0 fw-bold">Documents officiels</h5>
                </div>
                <div class="text-muted small">
                  <i class="bi bi-collection me-1"></i>Total : {{ documents|length }}
                </div>
              </div>
            </div>

            <div class="card-body pt-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 app-table">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th class="text-center" style="width:120px;">Version</th>
                      <th class="text-end" style="width:240px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in documents %}
                      <tr>
                        <td>
                          <div class="fw-bold">{{ d.doc_type }}</div>
                          <div class="text-muted small">
                            <i class="bi bi-calendar3 me-1"></i>Ajouté le {{ d.uploaded_at|date:"d/m/Y" }}
                          </div>
                        </td>
                        <td class="text-center">
                          <span class="badge rounded-pill badge-soft-dark">v{{ d.version }}</span>
                        </td>
                        <td class="text-end">
                          <div class="btn-group">
                            <a href="{{ d.file.url }}" class="btn btn-sm btn-ghost" target="_blank">
                              <i class="bi bi-eye"></i><span>Voir</span>
                            </a>
                            <form method="post" action="{% url 'shipment_documents' shipment.id %}" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="action" value="share">
                              <input type="hidden" name="document_id" value="{{ d.id }}">
                              <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bi bi-share"></i><span>Partager</span>
                              </button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="3">
                          <div class="empty-state">
                            <i class="bi bi-folder2-open"></i>
                            <div class="mt-2 fw-semibold">Aucun document</div>
                            <div class="text-muted small">Les pièces seront listées ici dès leur ajout.</div>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </section>

        </div>

        <!-- RIGHT (SIDEBAR) -->
        <div class="col-lg-4">

          <!-- Timeline -->
          <section class="card app-card">
            <div class="card-body app-card__header">
              <div class="d-flex align-items-center gap-2">
                <div class="icon-tile icon-tile--soft">
                  <i class="bi bi-clock-history"></i>
                </div>
                <h5 class="mb-0 fw-bold">Historique du trajet</h5>
              </div>
            </div>

            <div class="card-body pt-0">
              <div class="timeline">
                {% for update in shipment.updates.all|dictsortreversed:"created_at" %}
                  <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-card">
                      <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="fw-semibold small">{{ update.status }}</div>
                        <div class="text-muted" style="font-size:.75rem;">
                          <i class="bi bi-clock me-1"></i>{{ update.created_at|date:"d M Y • H:i" }}
                        </div>
                      </div>
                      {% if update.notes %}
                        <div class="timeline-note">{{ update.notes }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% empty %}
                  <div class="empty-state py-4">
                    <i class="bi bi-clock-history"></i>
                    <div class="mt-2 fw-semibold">Aucun événement</div>
                    <div class="text-muted small">Aucune mise à jour enregistrée pour le moment.</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </section>

          <!-- Chat quick hint -->
          <div class="hint-card mt-4">
            <div class="d-flex gap-2">
              <i class="bi bi-info-circle"></i>
              <div class="small">
                <div class="fw-semibold">Conseil</div>
                <div class="text-muted">Utilisons le chat pour partager rapidement un document ou une info d’étape.</div>
              </div>
            </div>
          </div>

        </div>

      </div>

      <!-- CHAT -->
      <section class="mt-5" id="chat">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <div class="icon-tile">
              <i class="bi bi-chat-dots"></i>
            </div>
            <h5 class="fw-bold mb-0">Discussion d’équipe</h5>
          </div>
          <div class="text-muted small">
            <i class="bi bi-chat-left-text me-1"></i>{{ chat_messages|length }} message(s)
          </div>
        </div>

        <div class="card app-card chat-card">
          <div id="chat-box" class="chat-box">
            {% for msg in chat_messages %}
              <div class="msg-row {% if msg.author == request.user %}is-me{% else %}is-other{% endif %}">
                <div class="msg-bubble">
                  {% if msg.author != request.user %}
                    <div class="msg-author">
                      <i class="bi bi-person-badge me-1"></i>{{ msg.author.username }}
                    </div>
                  {% endif %}
                  <div class="msg-text">{{ msg.body }}</div>
                  <div class="msg-meta">
                    <i class="bi bi-clock me-1"></i>{{ msg.created_at|date:"H:i" }}
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="empty-state py-5">
                <i class="bi bi-chat-square-dots"></i>
                <div class="mt-2 fw-semibold">Aucun message</div>
                <div class="text-muted small">Démarrons la discussion ici.</div>
              </div>
            {% endfor %}
          </div>

          <div class="chat-inputbar">
            <form method="post" action="{% url 'shipment_detail' shipment.id %}#chat" class="d-flex gap-2 align-items-center w-100">
              {% csrf_token %}
              <input type="hidden" name="form_name" value="chat">

              <div class="input-wrap">
                <i class="bi bi-pencil-square"></i>
                <input type="text" name="body" class="form-control chat-input" placeholder="Écrire un message…" required>
              </div>

              <button type="submit" class="btn btn-primary chat-send">
                <i class="bi bi-send-fill"></i>
                <span class="d-none d-sm-inline">Envoyer</span>
              </button>
            </form>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<style>
  /* ======= SYSTEM THEME (safe, no external deps) ======= */
  :root{
    --bg: #0b1220;
    --card: #0f1a2b;
    --card2:#0e1726;
    --stroke: rgba(255,255,255,.08);
    --muted: rgba(255,255,255,.65);
    --text: rgba(255,255,255,.92);
    --primary: #4f8cff;          /* stable “business” blue */
    --primary2:#2b6cff;
    --success: #22c55e;
    --shadow: 0 18px 45px rgba(0,0,0,.35);
    --radius: 18px;
    --radius2: 14px;
  }

  /* Étape 1: densifier la mise en page (évite l'effet "vide") */
 .app-container{
  max-width: 1320px !important;
  margin: 0 auto !important;
}

  /* Shell */
  .app-shell{
    min-height: 100vh;
    background:
      radial-gradient(circle at 15% 10%, rgba(79,140,255,.18), transparent 45%),
      radial-gradient(circle at 80% 0%, rgba(34,197,94,.12), transparent 40%),
      linear-gradient(180deg, #070b14 0%, #0b1220 100%);
    color: var(--text);
  }

  /* Fixed Header */
  .app-header{
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 50;
    backdrop-filter: blur(10px);
    background: rgba(7,11,20,.65);
    border-bottom: 1px solid var(--stroke);
    padding: 14px 18px;
    display:flex; align-items:center; justify-content:space-between;
    gap: 14px;
  }
  .app-header__left{ display:flex; align-items:center; gap: 14px; flex: 1; min-width: 0; }
  .app-header__right{ display:flex; align-items:center; gap: 10px; flex-shrink: 0; }

  .brand{ display:flex; align-items:center; gap: 10px; min-width: 0; }
  .brand__logo{
    width: 42px; height: 42px;
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, rgba(79,140,255,.22), rgba(79,140,255,.10));
    border: 1px solid rgba(79,140,255,.25);
    color: #cfe2ff;
  }
  .brand__name{ font-weight: 800; letter-spacing: .2px; line-height: 1.1; }
  .brand__sub{
    font-size: .78rem;
    color: var(--muted);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 520px;
  }

  .header-divider{
    width: 1px; height: 36px; background: var(--stroke);
    flex-shrink: 0;
  }
  .header-meta{ display:flex; align-items:center; gap: 10px; min-width: 0; flex-wrap: wrap; }
  .meta-pill{
    display:flex; align-items:center; gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    color: var(--text);
    max-width: 100%;
  }
  .status-pill{
    display:flex; align-items:center; gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(34,197,94,.25);
    background: rgba(34,197,94,.08);
    color: rgba(203,255,224,.95);
    font-weight: 700;
    font-size: .85rem;
  }
  .status-pill .dot{
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 0 4px rgba(34,197,94,.15);
  }

  /* Main spacing under fixed header */
  .app-main{ padding-top: 84px; }
  .app-container{ padding-bottom: 60px; }

  /* Cards */
  .app-card{
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, rgba(255,255,255,.02) 100%);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .app-card__header{
    border-bottom: 1px solid var(--stroke);
    padding: 18px 18px;
  }

  .icon-tile{
    width: 44px; height: 44px;
    border-radius: 14px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(79,140,255,.12);
    border: 1px solid rgba(79,140,255,.18);
    color: #cfe2ff;
  }
  .icon-tile--soft{
    background: rgba(255,255,255,.04);
    border: 1px solid var(--stroke);
    color: rgba(255,255,255,.80);
  }

  /* Pills / badges */
  .badge-soft-primary{
    background: rgba(79,140,255,.14) !important;
    border: 1px solid rgba(79,140,255,.22);
    color: rgba(226,238,255,.95) !important;
    font-weight: 800;
  }
  .badge-soft-dark{
    background: rgba(255,255,255,.06) !important;
    border: 1px solid var(--stroke);
    color: rgba(255,255,255,.85) !important;
    font-weight: 700;
  }

  /* Buttons */
  .btn-ghost{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    color: var(--text);
    border-radius: 12px;
    display:inline-flex; align-items:center; gap: 8px;
    padding: 8px 12px;
  }
  .btn-ghost:hover{ background: rgba(255,255,255,.06); color: var(--text); }
  .btn-pill{ border-radius: 999px; padding: 8px 14px; display:inline-flex; align-items:center; gap: 8px; }
  .btn-primary{
    background: linear-gradient(180deg, var(--primary) 0%, var(--primary2) 100%);
    border: 1px solid rgba(79,140,255,.35);
  }

  /* Info boxes */
  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (max-width: 768px){ .grid-2{ grid-template-columns: 1fr; } }
  .info-box{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    border-radius: var(--radius2);
    padding: 14px 14px;
  }
  .info-box__label{
    font-size: .78rem;
    color: var(--muted);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .05em;
    margin-bottom: 6px;
  }
  .info-box__value{ font-weight: 900; }
  .info-box__sub{ color: var(--muted); font-size: .9rem; margin-top: 2px; }

  /* Table */
  .app-table thead th{
    background: rgba(255,255,255,.04);
    color: rgba(255,255,255,.82);
    border-bottom: 1px solid var(--stroke);
    font-size: .85rem;
    letter-spacing: .02em;
  }
  .app-table td{
    border-color: rgba(255,255,255,.06) !important;
    color: rgba(255,255,255,.88);
  }
  .table-hover tbody tr:hover{
    background: rgba(79,140,255,.06);
  }

  /* Timeline */
  .timeline{ position: relative; padding-left: 18px; margin-left: 6px; border-left: 2px solid rgba(255,255,255,.10); }
  .timeline-item{ position: relative; padding-bottom: 14px; }
  .timeline-dot{
    position: absolute;
    left: -11px; top: 14px;
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--primary);
    box-shadow: 0 0 0 5px rgba(79,140,255,.12);
  }
  .timeline-card{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    border-radius: var(--radius2);
    padding: 12px 12px;
  }
  .timeline-note{
    margin-top: 10px;
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid rgba(79,140,255,.18);
    background: rgba(79,140,255,.08);
    color: rgba(235,244,255,.95);
    font-size: .92rem;
  }

  /* Hint card */
  .hint-card{
    border: 1px dashed rgba(255,255,255,.18);
    border-radius: var(--radius);
    background: rgba(255,255,255,.02);
    padding: 14px 14px;
    color: rgba(255,255,255,.86);
  }
  .hint-card i{ color: rgba(255,255,255,.70); }

  /* Empty state */
  .empty-state{
    text-align:center;
    padding: 26px 10px;
    color: rgba(255,255,255,.85);
  }
  .empty-state i{ font-size: 2rem; color: rgba(255,255,255,.55); }

  /* Chat */
  .chat-card{ overflow: hidden; }
  .chat-box{
    height: 520px;
    overflow-y: auto;
    padding: 18px;
    background:
      radial-gradient(circle at 15% 10%, rgba(79,140,255,.12), transparent 45%),
      radial-gradient(circle at 85% 0%, rgba(34,197,94,.08), transparent 40%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  }
  .msg-row{ display:flex; margin-bottom: 12px; }
  .msg-row.is-me{ justify-content:flex-end; }
  .msg-row.is-other{ justify-content:flex-start; }

  .msg-bubble{
    max-width: 76%;
    border-radius: 16px;
    padding: 12px 12px;
    border: 1px solid var(--stroke);
    box-shadow: 0 14px 34px rgba(0,0,0,.25);
  }
  .msg-row.is-me .msg-bubble{
    background: linear-gradient(180deg, rgba(34,197,94,.16), rgba(34,197,94,.10));
    border-color: rgba(34,197,94,.20);
    border-bottom-right-radius: 6px;
  }
  .msg-row.is-other .msg-bubble{
    background: rgba(255,255,255,.04);
    border-bottom-left-radius: 6px;
  }

  .msg-author{
    font-size: .78rem;
    font-weight: 900;
    color: rgba(210,230,255,.95);
    margin-bottom: 6px;
  }
  .msg-text{
    white-space: pre-wrap;
    line-height: 1.45;
    color: rgba(255,255,255,.92);
    font-size: .95rem;
  }
  .msg-meta{
    margin-top: 8px;
    font-size: .72rem;
    color: rgba(255,255,255,.60);
    display:flex; justify-content:flex-end; align-items:center;
    gap: 6px;
  }

  /* Sticky input bar */
  .chat-inputbar{
    position: sticky;
    bottom: 0;
    background: rgba(7,11,20,.85);
    border-top: 1px solid var(--stroke);
    padding: 12px;
    backdrop-filter: blur(10px);
  }
  .input-wrap{
    flex: 1;
    display:flex;
    align-items:center;
    gap: 10px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .input-wrap i{ color: rgba(255,255,255,.60); }
  .chat-input{
    border: none !important;
    outline: none !important;
    background: transparent !important;
    color: rgba(255,255,255,.92) !important;
    padding: 0 !important;
    box-shadow: none !important;
  }
  .chat-input::placeholder{ color: rgba(255,255,255,.55); }
  .chat-send{
    border-radius: 14px;
    padding: 10px 14px;
    display:inline-flex; align-items:center; gap: 8px;
    font-weight: 800;
  }

  /* Scrollbar */
  .chat-box::-webkit-scrollbar{ width: 8px; }
  .chat-box::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; }
  .chat-box::-webkit-scrollbar-track{ background: transparent; }

 /* styles existants */

  /* Étape 1 */
  .app-container{
    max-width: 1320px !important;
    margin: 0 auto !important;
  }

  /* Étape 2 */
  .app-table{
    background: rgba(255,255,255,.02);
    border-radius: 14px;
    overflow: hidden;
  }

  .app-table thead th{
    background: rgba(255,255,255,.06) !important;
    color: rgba(255,255,255,.82) !important;
    border-bottom: 1px solid rgba(255,255,255,.08) !important;
  }

  .app-table tbody td{
    background: transparent !important;
    color: rgba(255,255,255,.90) !important;
    border-color: rgba(255,255,255,.06) !important;
  }

  .table-hover tbody tr:hover{
    background: rgba(79,140,255,.06) !important;
  }

  /* Étape 3 */
  .input-wrap{
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }

  .input-wrap:focus-within{
    border-color: rgba(79,140,255,.55) !important;
    box-shadow: 0 0 0 3px rgba(79,140,255,.20) !important;
    background: rgba(255,255,255,.05) !important;
  }
</style>

<script>
  window.addEventListener("load", function () {
    var chat = document.getElementById("chat-box");
    if (chat) chat.scrollTop = chat.scrollHeight;
  });
</script>

{% endblock %}
