{% extends "ui/base.html" %}

{% block title %}Détail du conteneur - FagouFlow{% endblock %}

{% block content %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="card-title mb-0">Conteneur</h5>
        <div class="d-flex gap-2">
          {% if shipment.status == "CREATED" %}
            <span class="badge text-bg-secondary">{{ shipment.status_label }}</span>
          {% elif shipment.status == "IN_TRANSIT" %}
            <span class="badge text-bg-warning">{{ shipment.status_label }}</span>
          {% elif shipment.status == "ARRIVED" %}
            <span class="badge text-bg-info">{{ shipment.status_label }}</span>
          {% elif shipment.status == "CLEARED" %}
            <span class="badge text-bg-primary">{{ shipment.status_label }}</span>
          {% elif shipment.status == "DELIVERED" %}
            <span class="badge text-bg-success">{{ shipment.status_label }}</span>
          {% else %}
            <span class="badge text-bg-light text-dark">{{ shipment.status }}</span>
          {% endif %}

          {% if shipment.destination_site %}
            <span class="badge text-bg-dark">{{ shipment.destination_site }}</span>
          {% else %}
            <span class="badge text-bg-light text-dark">(aucun site)</span>
          {% endif %}
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <p class="mb-1"><strong>N° conteneur :</strong> {{ shipment.container_no }}</p>
          <p class="mb-1"><strong>N° BL :</strong> {{ shipment.bl_no }}</p>
          <p class="mb-1"><strong>Pays d’origine :</strong> {{ shipment.origin_country }}</p>
          <p class="mb-0"><strong>Type de destination :</strong> {{ shipment.destination_type }}</p>
        </div>
        <div class="col-12 col-md-6">
          <p class="mb-1"><strong>Site de destination :</strong> {{ shipment.destination_site|default:"(aucun site)" }}</p>
          <p class="mb-1"><strong>Client :</strong> {{ shipment.client_name|default:"(aucun)" }}</p>
          <p class="mb-1"><strong>Statut :</strong> {{ shipment.status_label }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">Marchandises</h5>
      {% if items %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>Produit</th>
                <th class="text-end">Qté</th>
                <th class="text-end">Prix unitaire</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
                <tr>
                  <td>{{ item.product.name }}</td>
                  <td class="text-end">{{ item.qty }}</td>
                  <td class="text-end">{{ item.unit_price }}</td>
                  <td class="text-end">{{ item.line_total }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="mb-0">Aucune marchandise.</p>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">Documents</h5>
      <form method="post" enctype="multipart/form-data" class="row g-3 mb-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="upload" />
        <div class="col-12 col-md-3">
          <label class="form-label" for="title">Titre</label>
          <input class="form-control" type="text" id="title" name="title" required />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label" for="doc_type">Type</label>
          <select class="form-select" id="doc_type" name="doc_type" required>
            <option value="BL">BL</option>
            <option value="INVOICE">Facture</option>
            <option value="PHOTO">Photo</option>
            <option value="OTHER">Autre</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label" for="description">Description</label>
          <input class="form-control" type="text" id="description" name="description" />
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label" for="file">Fichier</label>
          <input class="form-control" type="file" id="file" name="file" required />
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit">Ajouter un document</button>
        </div>
      </form>
      {% if share_url %}
        <div class="alert alert-success d-flex align-items-center justify-content-between gap-2">
          <div>
            Lien de partage :
            <a href="{{ share_url }}">{{ share_url }}</a>
          </div>
          <button class="btn btn-sm btn-outline-success" type="button" data-copy-link="{{ share_url }}">
            Copier
          </button>
        </div>
      {% endif %}
      {% if documents %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Description</th>
                <th>Fichier</th>
                <th>Type</th>
                <th>Date d’upload</th>
                <th>Partage avec</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in documents %}
                <tr>
                  <td>{{ doc.title|default:doc.file.name }}</td>
                  <td>{% if doc.description %}{{ doc.description }}{% else %}—{% endif %}</td>
                  <td>{{ doc.file.name }}</td>
                  <td>{{ doc.doc_type }}</td>
                  <td>{{ doc.uploaded_at|date:"d/m/Y H:i" }}</td>
                  <td>
                    {% if doc.site_shares.all %}
                      {% for share in doc.site_shares.all %}{{ share.site }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ doc.file.url }}">Télécharger</a>
                    {% if doc.can_share %}
                      <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="share" />
                        <input type="hidden" name="document_id" value="{{ doc.id }}" />
                        <button type="submit" class="btn btn-sm btn-outline-success">Partager</button>
                      </form>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td colspan="7">
                    <form method="post" class="d-flex align-items-center gap-2">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="share_site" />
                      <input type="hidden" name="document_id" value="{{ doc.id }}" />
                      <label class="visually-hidden" for="site_{{ doc.id }}">Site</label>
                      <select class="form-select form-select-sm" id="site_{{ doc.id }}" name="site" required>
                        <option value="" selected>Choisir un site</option>
                        <option value="PN">PN</option>
                        <option value="DLA">DLA</option>
                        <option value="KIN">KIN</option>
                      </select>
                      <button type="submit" class="btn btn-sm btn-outline-dark">Valider</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="mb-0">Aucun document pour ce conteneur.</p>
      {% endif %}
    </div>
  </div>

  {% if shared_documents %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Documents partagés avec votre site</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Description</th>
                <th>Fichier</th>
                <th>Type</th>
                <th>Date d’upload</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for doc in shared_documents %}
                <tr>
                  <td>{{ doc.title|default:doc.file.name }}</td>
                  <td>{% if doc.description %}{{ doc.description }}{% else %}—{% endif %}</td>
                  <td>{{ doc.file.name }}</td>
                  <td>{{ doc.doc_type }}</td>
                  <td>{{ doc.uploaded_at|date:"d/m/Y H:i" }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ doc.file.url }}">Télécharger</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  <div id="chat" class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Espace de discussion</h5>
        <span class="text-muted small">{{ chat_count }} message{{ chat_count|pluralize }}</span>
      </div>
      <p class="text-muted small mb-3">Ce chat est lié à ce conteneur uniquement.</p>
      <div class="border rounded p-3 bg-light" style="max-height:320px; overflow-y:auto;">
        {% if chat_messages %}
          <div class="d-flex flex-column gap-3">
            {% for msg in chat_messages %}
              {% if msg.author and msg.author.id == user.id %}
                <div class="d-flex justify-content-end">
                  <div class="d-flex flex-row-reverse align-items-start gap-2">
                    {% if msg.author.avatar %}
                      <img
                        src="{{ msg.author.avatar.url }}"
                        alt="Avatar"
                        width="32"
                        height="32"
                        class="rounded-circle border"
                      />
                    {% else %}
                      <span
                        class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center"
                        style="width:32px;height:32px;font-size:0.75rem;"
                      >
                        {{ msg.author.full_name|default:msg.author.email|slice:":1" }}
                      </span>
                    {% endif %}
                    <div class="text-end">
                      <div class="small text-muted">
                        {{ msg.author.full_name|default:msg.author.email }} · {{ msg.author.role }} / {{ msg.site }} · {{ msg.created_at|date:"d/m/Y H:i" }}
                      </div>
                      <div class="bg-primary text-white rounded px-3 py-2 mt-1">
                        {{ msg.body }}
                      </div>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="d-flex justify-content-start">
                  <div class="d-flex align-items-start gap-2">
                    {% if msg.author and msg.author.avatar %}
                      <img
                        src="{{ msg.author.avatar.url }}"
                        alt="Avatar"
                        width="32"
                        height="32"
                        class="rounded-circle border"
                      />
                    {% else %}
                      <span
                        class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center"
                        style="width:32px;height:32px;font-size:0.75rem;"
                      >
                        {% if msg.author %}
                          {{ msg.author.full_name|default:msg.author.email|slice:":1" }}
                        {% else %}
                          ?
                        {% endif %}
                      </span>
                    {% endif %}
                    <div>
                      <div class="small text-muted">
                        {% if msg.author %}{{ msg.author.full_name|default:msg.author.email }}{% else %}Utilisateur{% endif %} ·
                        {% if msg.author %}{{ msg.author.role }}{% else %}—{% endif %} / {{ msg.site }} · {{ msg.created_at|date:"d/m/Y H:i" }}
                      </div>
                      <div class="bg-white border rounded px-3 py-2 mt-1">
                        {{ msg.body }}
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <p class="mb-0 text-muted">Aucun message.</p>
        {% endif %}
      </div>
      <form method="post" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="chat" />
        <div class="d-flex gap-2">
          <textarea
            class="form-control"
            name="body"
            rows="2"
            maxlength="2000"
            placeholder="Message..."
            required
          ></textarea>
          <button type="submit" class="btn btn-primary">Envoyer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.querySelectorAll("[data-copy-link]").forEach((button) => {
      button.addEventListener("click", () => {
        const link = button.getAttribute("data-copy-link");
        if (navigator.clipboard && link) {
          navigator.clipboard.writeText(link);
        }
      });
    });
  </script>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Historique des actions</h5>
      {% if timeline %}
        <div class="list-group list-group-flush ui-timeline">
          {% for item in timeline %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="fw-semibold">{{ item.action_label }}</div>
                  <div class="text-muted small">{{ item.user }}</div>
                  <div class="small">{{ item.detail }}</div>
                </div>
                <div class="text-end">
                  <small class="text-muted d-block">{{ item.date|date:"d/m/Y H:i" }}</small>
                  {% if item.action_type == "CREATE" %}
                    <span class="badge text-bg-success">Créé</span>
                  {% elif item.action_type == "UPDATE" %}
                    <span class="badge text-bg-primary">Mis à jour</span>
                  {% elif item.action_type == "DELETE" %}
                    <span class="badge text-bg-danger">Supprimé</span>
                  {% elif item.action_type == "STATUS_CHANGE" %}
                    <span class="badge text-bg-info">Statut</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ item.action_type }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="mb-0">Aucune action enregistrée.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
